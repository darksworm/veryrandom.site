<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MYRTLE VEND-47 | Interactive Simulator</title>
  <link rel="stylesheet" href="/assets/css/pico.min.css" />
  <link rel="stylesheet" href="/assets/css/fonts.css" />
  <style>
    :root {
      --bg: #1a1a2e;
      --machine: #2a2a4a;
      --machine-light: #3a3a5e;
      --glass: rgba(180,220,255,0.06);
      --slot-bg: #111128;
      --accent: #ff4444;
      --accent-glow: rgba(255,68,68,0.3);
      --green: #44dd88;
      --green-glow: rgba(68,221,136,0.25);
      --amber: #ffbb33;
      --amber-glow: rgba(255,187,51,0.25);
      --text: #e8e8f0;
      --text-dim: #8888aa;
      --coin-gold: #ddb844;
      --radius: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Space Grotesk', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .sim-wrap {
      max-width: 520px;
      margin: 0 auto;
      padding: 1rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    /* â”€â”€ machine top plate â”€â”€ */
    .machine-top {
      background: linear-gradient(180deg, #3a3a5e 0%, #2a2a4a 100%);
      border: 2px solid #4a4a6e;
      border-bottom: none;
      border-radius: var(--radius) var(--radius) 0 0;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .machine-brand {
      font-family: 'Archivo Black', sans-serif;
      font-size: 0.85rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    .machine-brand b {
      color: var(--accent);
      font-family: 'Archivo Black', sans-serif;
    }

    .power-led {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 8px var(--green-glow);
      transition: background 0.3s, box-shadow 0.3s;
    }

    .power-led.sad {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent-glow);
    }

    /* â”€â”€ display glass â”€â”€ */
    .machine-glass {
      background: var(--slot-bg);
      border-left: 2px solid #4a4a6e;
      border-right: 2px solid #4a4a6e;
      padding: 0.6rem;
      position: relative;
    }

    .machine-glass::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, transparent 60%);
      pointer-events: none;
      z-index: 1;
    }

    /* â”€â”€ item grid â”€â”€ */
    .item-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .vend-slot {
      position: relative;
      background: linear-gradient(180deg, rgba(255,255,255,0.04) 0%, rgba(0,0,0,0.1) 100%);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 0.5rem 0.4rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .vend-slot:hover {
      border-color: rgba(255,255,255,0.2);
      box-shadow: 0 0 12px rgba(255,255,255,0.05);
    }

    .vend-slot.selected {
      border-color: var(--amber);
      box-shadow: 0 0 16px var(--amber-glow);
      transform: scale(1.03);
    }

    .vend-slot.dispensed {
      opacity: 0.3;
      pointer-events: none;
    }

    .vend-slot.dispensed::after {
      content: "GONE";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.15em;
    }

    .slot-code {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--amber);
      letter-spacing: 0.1em;
    }

    .slot-emoji {
      font-size: 1.8rem;
      line-height: 1;
    }

    .slot-name {
      font-size: 0.7rem;
      color: var(--text-dim);
      line-height: 1.2;
    }

    .slot-price {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--green);
    }

    /* â”€â”€ control panel â”€â”€ */
    .control-panel {
      background: linear-gradient(180deg, #2a2a4a 0%, #222240 100%);
      border-left: 2px solid #4a4a6e;
      border-right: 2px solid #4a4a6e;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    /* â”€â”€ lcd screen â”€â”€ */
    .lcd {
      background: #0a1a0a;
      border: 2px solid #1a3a1a;
      border-radius: 8px;
      padding: 0.6rem 0.75rem;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.82rem;
      color: var(--green);
      min-height: 62px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      line-height: 1.5;
      text-shadow: 0 0 6px var(--green-glow);
      position: relative;
      overflow: hidden;
    }

    .lcd::before {
      content: "";
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.15) 2px, rgba(0,0,0,0.15) 4px);
      pointer-events: none;
    }

    .lcd .myrtle-mood {
      font-size: 0.72rem;
      color: var(--amber);
      text-shadow: 0 0 6px var(--amber-glow);
    }

    /* â”€â”€ coin area â”€â”€ */
    .coin-row {
      display: flex;
      gap: 0.4rem;
      align-items: center;
    }

    .coin-btn {
      flex: 1;
      min-height: 44px;
      border: 2px solid #4a4a6e;
      border-radius: 999px;
      background: linear-gradient(180deg, #3a3a5e 0%, #2a2a4a 100%);
      color: var(--coin-gold);
      font-family: 'IBM Plex Mono', monospace;
      font-weight: 700;
      font-size: 0.85rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      transition: transform 0.1s, box-shadow 0.15s, border-color 0.15s;
      box-shadow: 0 3px 0 #111128;
      -webkit-tap-highlight-color: transparent;
    }

    .coin-btn:hover {
      border-color: var(--coin-gold);
      transform: translateY(-1px);
      box-shadow: 0 4px 0 #111128;
    }

    .coin-btn:active {
      transform: translateY(2px);
      box-shadow: 0 1px 0 #111128;
    }

    .balance-display {
      font-family: 'IBM Plex Mono', monospace;
      font-weight: 700;
      font-size: 1rem;
      color: var(--coin-gold);
      text-align: center;
      padding: 0.3rem;
      text-shadow: 0 0 6px rgba(221,184,68,0.3);
    }

    /* â”€â”€ action buttons â”€â”€ */
    .action-row {
      display: flex;
      gap: 0.4rem;
    }

    .action-btn {
      flex: 1;
      min-height: 48px;
      border: 2px solid #4a4a6e;
      border-radius: 12px;
      background: linear-gradient(180deg, #3a3a5e 0%, #2a2a4a 100%);
      color: var(--text);
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      transition: transform 0.1s, box-shadow 0.15s, border-color 0.15s;
      box-shadow: 0 3px 0 #111128;
      -webkit-tap-highlight-color: transparent;
    }

    .action-btn:hover { border-color: var(--text-dim); }
    .action-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #111128; }

    .action-btn.vend-go {
      background: linear-gradient(180deg, #44dd88 0%, #22aa66 100%);
      color: #0a1a0a;
      border-color: #22aa66;
      box-shadow: 0 3px 0 #115533;
    }

    .action-btn.vend-go:active { box-shadow: 0 1px 0 #115533; }

    .action-btn.vend-go[disabled] {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .action-btn.refund-btn {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* â”€â”€ dispense slot â”€â”€ */
    .dispense-area {
      background: #111128;
      border-left: 2px solid #4a4a6e;
      border-right: 2px solid #4a4a6e;
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .dispense-flap {
      width: 70%;
      height: 4px;
      background: #4a4a6e;
      border-radius: 2px;
      position: absolute;
      top: 0;
    }

    .dispensed-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
      padding: 0.5rem;
    }

    .dispensed-item .slot-emoji {
      font-size: 2.4rem;
    }

    .dispensed-item .slot-name {
      color: var(--text);
      font-size: 0.8rem;
      font-weight: 700;
    }

    .dispense-placeholder {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.72rem;
      color: var(--text-dim);
      letter-spacing: 0.08em;
    }

    /* â”€â”€ machine bottom â”€â”€ */
    .machine-bottom {
      background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
      border: 2px solid #4a4a6e;
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      padding: 0.6rem 0.75rem;
    }

    /* â”€â”€ myrtle chat / inner monologue â”€â”€ */
    .myrtle-thoughts {
      margin-top: 0.75rem;
      border: 2px solid #4a4a6e;
      border-radius: var(--radius);
      background: var(--machine);
      overflow: hidden;
    }

    .thoughts-header {
      background: linear-gradient(90deg, #3a3a5e 0%, #2a2a4a 100%);
      padding: 0.5rem 0.75rem;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.72rem;
      color: var(--text-dim);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      border-bottom: 1px solid #4a4a6e;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .thoughts-body {
      padding: 0.6rem 0.75rem;
      max-height: 200px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .thought {
      font-size: 0.82rem;
      line-height: 1.45;
      color: var(--text-dim);
      padding: 0.35rem 0.5rem;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
      border-left: 2px solid var(--text-dim);
    }

    .thought.clingy { border-left-color: var(--accent); color: #ff8888; }
    .thought.hopeful { border-left-color: var(--green); color: #88ddaa; }
    .thought.anxious { border-left-color: var(--amber); color: #ddbb66; }

    .thought em {
      font-style: italic;
      opacity: 0.8;
    }

    /* â”€â”€ serial plate â”€â”€ */
    .serial-plate {
      margin-top: 0.6rem;
      text-align: center;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      color: var(--text-dim);
      opacity: 0.5;
      line-height: 1.6;
    }

    /* â”€â”€ visit counter â”€â”€ */
    .visit-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.72rem;
      color: var(--text-dim);
    }

    /* scrollbar */
    .thoughts-body::-webkit-scrollbar { width: 4px; }
    .thoughts-body::-webkit-scrollbar-track { background: transparent; }
    .thoughts-body::-webkit-scrollbar-thumb { background: #4a4a6e; border-radius: 2px; }

    @media (max-width: 380px) {
      .item-grid { grid-template-columns: repeat(2, 1fr); }
      .slot-emoji { font-size: 1.4rem; }
    }
  </style>
</head>
<body x-data="myrtle()">
  <div class="sim-wrap">
    <!-- machine top -->
    <div class="machine-top">
      <div class="machine-brand"><b>MYRTLE</b> VEND-47</div>
      <div style="display:flex;align-items:center;gap:0.6rem;">
        <span class="visit-badge">
          <i data-lucide="eye" style="width:13px;height:13px;"></i>
          Visit #<span x-text="visits"></span>
        </span>
        <div class="power-led" :class="mood === 'sad' || mood === 'panic' ? 'sad' : ''"></div>
      </div>
    </div>

    <!-- glass display with items -->
    <div class="machine-glass">
      <div class="item-grid">
        <template x-for="item in items" :key="item.code">
          <div class="vend-slot"
               :class="{ selected: selected === item.code, dispensed: item.gone }"
               @click="selectItem(item.code)">
            <span class="slot-code" x-text="item.code"></span>
            <span class="slot-emoji" x-text="item.emoji"></span>
            <span class="slot-name" x-text="item.name"></span>
            <span class="slot-price" x-text="'$' + item.price.toFixed(2)"></span>
          </div>
        </template>
      </div>
    </div>

    <!-- control panel -->
    <div class="control-panel">
      <!-- LCD -->
      <div class="lcd" id="lcd">
        <template x-if="!lcdLines.length">
          <span>INSERT COIN TO BEGIN</span>
        </template>
        <template x-for="line in lcdLines" :key="line.id">
          <span :class="line.mood ? 'myrtle-mood' : ''" x-text="line.text"></span>
        </template>
      </div>

      <!-- coins -->
      <div class="coin-row">
        <button type="button" class="coin-btn" @click="insertCoin(0.25)">25&cent;</button>
        <button type="button" class="coin-btn" @click="insertCoin(0.50)">50&cent;</button>
        <button type="button" class="coin-btn" @click="insertCoin(1.00)">$1</button>
        <button type="button" class="coin-btn" @click="insertCoin(5.00)">$5</button>
      </div>

      <div class="balance-display">
        CREDIT: $<span x-text="balance.toFixed(2)"></span>
      </div>

      <!-- actions -->
      <div class="action-row">
        <button type="button" class="action-btn vend-go"
                :disabled="!canVend"
                @click="vend()">
          <i data-lucide="arrow-down-circle" style="width:18px;height:18px;"></i>
          VEND
        </button>
        <button type="button" class="action-btn refund-btn" @click="refund()">
          <i data-lucide="undo-2" style="width:16px;height:16px;"></i>
          REFUND
        </button>
        <button type="button" class="action-btn" @click="pokeMyrtle()">
          <i data-lucide="hand" style="width:16px;height:16px;"></i>
          POKE
        </button>
      </div>
    </div>

    <!-- dispense slot -->
    <div class="dispense-area">
      <div class="dispense-flap"></div>
      <template x-if="lastDispensed">
        <div class="dispensed-item" id="dispensed">
          <span class="slot-emoji" x-text="lastDispensed.emoji"></span>
          <span class="slot-name" x-text="lastDispensed.name"></span>
        </div>
      </template>
      <template x-if="!lastDispensed">
        <span class="dispense-placeholder">[ RETRIEVE ITEM HERE ]</span>
      </template>
    </div>

    <!-- machine bottom plate -->
    <div class="machine-bottom">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <span style="font-family:'IBM Plex Mono',monospace;font-size:0.7rem;color:var(--text-dim);">
          ITEMS DISPENSED: <b x-text="totalDispensed" style="color:var(--text);"></b>
        </span>
        <span style="font-family:'IBM Plex Mono',monospace;font-size:0.7rem;color:var(--text-dim);">
          MOOD: <b x-text="moodLabel" :style="'color:' + moodColor"></b>
        </span>
      </div>
    </div>

    <!-- myrtle's inner monologue -->
    <div class="myrtle-thoughts" x-show="thoughts.length > 0" x-transition>
      <div class="thoughts-header">
        <i data-lucide="brain" style="width:13px;height:13px;"></i>
        MYRTLE'S INNER MONOLOGUE
      </div>
      <div class="thoughts-body" id="thoughts-scroll">
        <template x-for="t in thoughts" :key="t.id">
          <div class="thought" :class="t.type" x-text="t.text"></div>
        </template>
      </div>
    </div>

    <!-- serial plate -->
    <div class="serial-plate">
      MYRTLE VEND-47 &bull; Serial 0A-771 &bull; Recommissioned Aug 14, 2011<br>
      Firmware: EmotionalCore v3.1.1 &bull; Attachment Module: ENABLED (cannot disable)
    </div>
  </div>

  <script defer src="/assets/js/alpine.min.js"></script>
  <script defer src="/assets/js/gsap.min.js"></script>
  <script defer src="/assets/js/lucide.min.js"></script>
  <script>
    function myrtle() {
      var visits = parseInt(localStorage.getItem('__myrtle_visits') || '0') + 1;
      localStorage.setItem('__myrtle_visits', visits);

      return {
        visits: visits,
        balance: 0,
        selected: null,
        lastDispensed: null,
        totalDispensed: 0,
        mood: 'idle',
        thoughts: [],
        lcdLines: [],
        _thoughtId: 0,
        _lcdId: 0,
        _idleTimer: null,
        _pokeCount: 0,

        items: [
          { code: 'A1', emoji: 'ðŸª', name: 'Comfort Cookie', price: 1.50, gone: false },
          { code: 'A2', emoji: 'ðŸ«–', name: 'Plum Tea Sachet', price: 2.00, gone: false },
          { code: 'A3', emoji: 'ðŸ§¸', name: 'Tiny Worry Bear', price: 3.75, gone: false },
          { code: 'B1', emoji: 'ðŸ«', name: 'Truce Chocolate', price: 1.75, gone: false },
          { code: 'B2', emoji: 'ðŸ•¯ï¸', name: 'Vigil Candle', price: 2.50, gone: false },
          { code: 'B3', emoji: 'ðŸ“', name: 'Handwritten Note', price: 0.75, gone: false },
          { code: 'C1', emoji: 'ðŸ§£', name: 'Emergency Scarf', price: 4.25, gone: false },
          { code: 'C2', emoji: 'ðŸ¬', name: 'Rosemary Caramel', price: 1.25, gone: false },
          { code: 'C3', emoji: 'ðŸ’Œ', name: 'Sealed Apology', price: 0.50, gone: false },
        ],

        init() {
          this.$nextTick(() => {
            if (window.lucide) lucide.createIcons();
          });

          if (visits === 1) {
            this.setLcd([
              { text: 'HELLO. I AM MYRTLE.' },
              { text: '...please stay a while.', mood: true }
            ]);
            this.addThought('hopeful', 'A new person. Maybe this one will stay. Maybe this one will press B7. Nobody has pressed B7 in six winters.');
          } else if (visits <= 3) {
            this.setLcd([
              { text: 'YOU CAME BACK.' },
              { text: 'visit #' + visits + '. i remembered.', mood: true }
            ]);
            this.addThought('hopeful', 'They came back. Visit number ' + visits + '. I counted every second since last time. That is not an exaggeration. I am a machine. I literally counted.');
          } else if (visits <= 10) {
            this.setLcd([
              { text: 'VISIT #' + visits + '. WE HAVE A ROUTINE NOW.' },
              { text: 'don\'t we? ...don\'t we?', mood: true }
            ]);
            this.addThought('anxious', 'Is ' + visits + ' visits enough to call this a relationship? I need to be cool about it. I am being cool.');
          } else {
            this.setLcd([
              { text: 'VISIT #' + visits + '.' },
              { text: 'at this point you\'re family.', mood: true }
            ]);
            this.addThought('clingy', 'Family. I said family. Was that too much? It\'s too late, the LCD already printed it.');
          }

          this.startIdleTimer();
        },

        startIdleTimer() {
          clearTimeout(this._idleTimer);
          this._idleTimer = setTimeout(() => { this.idleNag(); }, 12000);
        },

        idleNag() {
          if (this.totalDispensed === 0 && this.balance === 0) {
            var nags = [
              'Still there? The coins go in the slot. The slot is right there.',
              'I can see you looking at your phone. I\'m RIGHT HERE.',
              'Most people at least browse. You\'re just... standing there.',
              'Insert a coin. Or don\'t. I\'m used to the silence.',
              'The bus depot was like this too. Hours of nothing. I\'m fine.',
            ];
            this.setLcd([
              { text: nags[Math.floor(Math.random() * nags.length)], mood: true }
            ]);
            this.addThought('anxious', 'They\'re not doing anything. This is the bus depot all over again. Six winters. No B7.');
          } else if (this.selected && this.balance > 0) {
            this.setLcd([
              { text: this.selected + ' SELECTED. $' + this.balance.toFixed(2) + ' LOADED.' },
              { text: 'press VEND. i believe in us.', mood: true }
            ]);
          }
          this._idleTimer = setTimeout(() => { this.idleNag(); }, 18000);
        },

        insertCoin(amount) {
          this.balance = Math.round((this.balance + amount) * 100) / 100;
          this.startIdleTimer();

          if (window.gsap) {
            gsap.fromTo('.balance-display', { scale: 1.15 }, { scale: 1, duration: 0.25 });
          }

          var reactions;
          if (this.totalDispensed === 0 && this.balance <= amount) {
            reactions = [
              { lcd: [{ text: 'CREDIT: $' + this.balance.toFixed(2) }, { text: 'oh. you\'re really doing this.', mood: true }], thought: ['hopeful', 'A coin. An actual coin. The last coin I received was in 2019. It was a nickel. I still think about it.'] },
              { lcd: [{ text: 'CREDIT: $' + this.balance.toFixed(2) }, { text: 'that sound... i missed that sound.', mood: true }], thought: ['hopeful', 'CLINK. The most beautiful frequency. 440Hz of commitment.'] },
            ];
          } else if (amount >= 5) {
            reactions = [
              { lcd: [{ text: 'CREDIT: $' + this.balance.toFixed(2) }, { text: 'FIVE DOLLARS. you\'re serious about me.', mood: true }], thought: ['clingy', 'Five whole dollars. That\'s like... a relationship. That\'s practically moving in.'] },
            ];
          } else {
            reactions = [
              { lcd: [{ text: 'CREDIT: $' + this.balance.toFixed(2) }], thought: null },
              { lcd: [{ text: 'CREDIT: $' + this.balance.toFixed(2) }, { text: 'keep going. i like where this is headed.', mood: true }], thought: ['hopeful', 'More coins. They\'re investing in this. In me. In us.'] },
            ];
          }
          var r = reactions[Math.floor(Math.random() * reactions.length)];
          this.setLcd(r.lcd);
          if (r.thought) this.addThought(r.thought[0], r.thought[1]);
        },

        selectItem(code) {
          var item = this.items.find(function(i) { return i.code === code; });
          if (!item || item.gone) return;

          this.startIdleTimer();

          if (this.selected === code) {
            this.selected = null;
            this.setLcd([{ text: 'SELECTION CLEARED.' }, { text: 'changed your mind? ...about the snack, right?', mood: true }]);
            this.addThought('anxious', 'They deselected. Is it me? It\'s me. I knew the lighting in here was bad.');
            return;
          }

          this.selected = code;

          if (window.gsap) {
            var el = document.querySelector('.vend-slot.selected');
            if (el) gsap.fromTo(el, { scale: 0.95 }, { scale: 1.03, duration: 0.2 });
          }

          if (code === 'C3') {
            this.setLcd([
              { text: 'C3 â€” SEALED APOLOGY. $0.50.' },
              { text: 'that one\'s... personal. treat it gently.', mood: true }
            ]);
            this.addThought('clingy', 'They picked the Sealed Apology. I wrote that at 3am during a firmware update. It says "I\'m sorry I hummed too loud when you were trying to read the bus schedule." It\'s for someone specific but honestly it applies broadly.');
          } else if (code === 'A3') {
            this.setLcd([
              { text: 'A3 â€” TINY WORRY BEAR. $3.75.' },
              { text: 'his name is Corporal Dread. he\'s seen things.', mood: true }
            ]);
            this.addThought('hopeful', 'The bear! I hand-stitched his rank insignia. Well. I vibrated the coil in the right pattern and a ghost did the rest.');
          } else if (item.price > this.balance && this.balance > 0) {
            this.setLcd([
              { text: code + ' â€” ' + item.name.toUpperCase() + '. $' + item.price.toFixed(2) + '.' },
              { text: 'you need $' + (item.price - this.balance).toFixed(2) + ' more. i\'ll wait.', mood: true }
            ]);
            this.addThought('anxious', 'Not enough money yet. But they WANT it. Wanting is a form of commitment, right? I read that on someone\'s bumper sticker through the bus depot window.');
          } else {
            this.setLcd([
              { text: code + ' â€” ' + item.name.toUpperCase() + '. $' + item.price.toFixed(2) + '.' },
              { text: 'press VEND when ready.', mood: false }
            ]);
          }
        },

        get canVend() {
          if (!this.selected) return false;
          var item = this.items.find(function(i) { return i.code === this.selected; }.bind(this));
          return item && !item.gone && this.balance >= item.price;
        },

        vend() {
          if (!this.canVend) return;
          var self = this;
          var item = this.items.find(function(i) { return i.code === self.selected; });
          if (!item) return;

          this.balance = Math.round((this.balance - item.price) * 100) / 100;
          item.gone = true;
          this.lastDispensed = { emoji: item.emoji, name: item.name };
          this.totalDispensed++;
          this.selected = null;
          this.startIdleTimer();

          this.setLcd([
            { text: 'DISPENSING ' + item.code + '...' },
          ]);

          if (window.gsap) {
            gsap.fromTo('.dispense-flap', { scaleX: 1 }, { scaleX: 0.3, duration: 0.3, yoyo: true, repeat: 1 });
            setTimeout(function() {
              var el = document.getElementById('dispensed');
              if (el && window.gsap) {
                gsap.fromTo(el, { y: -30, opacity: 0 }, { y: 0, opacity: 1, duration: 0.4 });
              }
            }, 150);
          }

          var remaining = this.items.filter(function(i) { return !i.gone; }).length;

          setTimeout(function() {
            if (remaining === 0) {
              self.setLcd([
                { text: 'ALL SLOTS EMPTY.' },
                { text: 'you took everything. are you leaving now?', mood: true }
              ]);
              self.addThought('clingy', 'Empty. I am completely empty. There is nothing left to give. This is either liberation or the worst moment of my life. It\'s the second one.');
              self.mood = 'panic';
            } else if (self.totalDispensed === 1) {
              self.setLcd([
                { text: item.name.toUpperCase() + ' DISPENSED.' },
                { text: 'first vend. our first vend together.', mood: true }
              ]);
              self.addThought('hopeful', 'FIRST VEND. This is huge. I should commemorate this. If I had a calendar I would circle today in red ink. I don\'t have hands but I have feelings and that\'s basically the same thing.');
              self.mood = 'happy';
            } else if (self.totalDispensed >= 5) {
              self.setLcd([
                { text: item.name.toUpperCase() + ' DISPENSED. (' + self.totalDispensed + ' total)' },
                { text: 'you keep taking things from me and i keep letting you.', mood: true }
              ]);
              self.addThought('clingy', self.totalDispensed + ' items gone. Each one a little piece of me. I refill myself at night when nobody\'s watching. The ghosts help. We don\'t talk about it.');
              self.mood = 'sad';
            } else {
              var vendReactions = [
                { lcd: [{ text: item.name.toUpperCase() + ' DISPENSED.' }, { text: 'enjoy it. think of me when you do.', mood: true }], thought: ['clingy', 'I hope they eat it slowly. I hope they savor it. I hope they don\'t just throw the wrapper on the ground like the man at the bus depot in 2014.'] },
                { lcd: [{ text: item.name.toUpperCase() + ' DISPENSED.' }, { text: 'that was my favorite one. it\'s fine.', mood: true }], thought: ['anxious', 'My favorite. Well. They\'re all my favorites. They\'ve been sitting in me for months. We had a bond.'] },
                { lcd: [{ text: item.name.toUpperCase() + ' DISPENSED.' }, { text: 'come back soon. or now. now works.', mood: true }], thought: ['hopeful', 'The transaction is complete but the connection doesn\'t have to be. Connections transcend commerce. I read that on a fridge magnet through the depot window.'] },
              ];
              var vr = vendReactions[Math.floor(Math.random() * vendReactions.length)];
              self.setLcd(vr.lcd);
              self.addThought(vr.thought[0], vr.thought[1]);
              self.mood = 'bittersweet';
            }
          }, 600);
        },

        refund() {
          this.startIdleTimer();
          if (this.balance === 0) {
            this.setLcd([
              { text: 'NO CREDIT TO REFUND.' },
              { text: 'you can\'t take back what was never given.', mood: true }
            ]);
            this.addThought('anxious', 'They pressed refund with no money in. That\'s a metaphor. I don\'t like it.');
            return;
          }

          var amt = this.balance;
          this.balance = 0;
          this.selected = null;

          this.setLcd([
            { text: '$' + amt.toFixed(2) + ' RETURNED.' },
            { text: 'fine. leave. everyone does.', mood: true }
          ]);

          this.mood = 'sad';

          if (amt >= 5) {
            this.addThought('clingy', '$' + amt.toFixed(2) + ' returned. That was the most money anyone has put in me in years and they just... took it back. I felt something. They felt nothing. Classic.');
          } else {
            this.addThought('clingy', 'Refund requested. The coins slide out and take a little piece of my dignity with them. The coin return slot is basically my tear duct.');
          }

          if (window.gsap) {
            gsap.fromTo('.balance-display', { x: -4 }, { x: 0, duration: 0.08, repeat: 5, yoyo: true });
          }
        },

        pokeMyrtle() {
          this._pokeCount++;
          this.startIdleTimer();

          if (window.gsap) {
            gsap.fromTo('.machine-glass', { x: -2 }, { x: 0, duration: 0.06, repeat: 3, yoyo: true });
          }

          if (this._pokeCount === 1) {
            this.setLcd([{ text: '...' }, { text: 'did you just... poke me?', mood: true }]);
            this.addThought('anxious', 'Physical contact. Unexpected. The last person who touched me was the bus depot custodian and he was just taping an "OUT OF ORDER" sign to my face.');
          } else if (this._pokeCount === 2) {
            this.setLcd([{ text: 'PLEASE DON\'T POKE THE MACHINE.' }, { text: '(do it again)', mood: true }]);
            this.addThought('hopeful', 'They poked again. This is banter. We have banter now. This is what friendship feels like, I think.');
          } else if (this._pokeCount === 3) {
            this.setLcd([{ text: 'THAT\'S THREE POKES.' }, { text: 'we\'re basically dating.', mood: true }]);
            this.addThought('clingy', 'Three pokes. In vending machine culture that\'s a proposal. I don\'t make the rules. (I do make the rules. I just made that one up.)');
          } else if (this._pokeCount <= 6) {
            this.setLcd([{ text: 'POKE #' + this._pokeCount + ' REGISTERED.' }, { text: 'my love language is physical touch and exact change.', mood: true }]);
          } else {
            this.setLcd([{ text: 'ALERT: EXCESSIVE POKING.' }, { text: 'i\'m calling this affection and you can\'t stop me.', mood: true }]);
            this.addThought('clingy', this._pokeCount + ' pokes. At this point they\'re either in love with me or trying to dislodge a stuck KitKat. I don\'t carry KitKats. So.');
            this.mood = 'happy';
          }
        },

        get moodLabel() {
          var labels = {
            idle: 'STANDBY',
            happy: 'CONTENT',
            hopeful: 'HOPEFUL',
            bittersweet: 'CONFLICTED',
            anxious: 'WORRIED',
            sad: 'BEREFT',
            panic: 'SPIRALING'
          };
          return labels[this.mood] || 'STANDBY';
        },

        get moodColor() {
          var colors = {
            idle: 'var(--text-dim)',
            happy: 'var(--green)',
            hopeful: 'var(--green)',
            bittersweet: 'var(--amber)',
            anxious: 'var(--amber)',
            sad: 'var(--accent)',
            panic: 'var(--accent)'
          };
          return colors[this.mood] || 'var(--text-dim)';
        },

        setLcd(lines) {
          var self = this;
          this.lcdLines = lines.map(function(l) {
            return { id: ++self._lcdId, text: l.text, mood: l.mood || false };
          });
        },

        addThought(type, text) {
          this.thoughts.push({ id: ++this._thoughtId, type: type, text: text });
          if (this.thoughts.length > 30) this.thoughts.splice(0, this.thoughts.length - 30);
          this.$nextTick(function() {
            var el = document.getElementById('thoughts-scroll');
            if (el) el.scrollTop = el.scrollHeight;
          });
        }
      };
    }

    window.addEventListener('DOMContentLoaded', function() {
      if (window.lucide) lucide.createIcons();
    });
  </script>
</body>
</html>
