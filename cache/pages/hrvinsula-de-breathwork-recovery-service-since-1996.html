<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HRVinsula.de — Recovery Through Respiratory Enforcement Since 1996</title>
<link rel="stylesheet" href="/assets/css/fonts.css">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --beige: #C8C0B8;
  --beige-flicker: #C0B8AF;
  --teal: #1F5A6A;
  --teal-dark: #174A56;
  --gray: #545050;
  --black: #2A2A2A;
  --yellow: #D4C957;
  --red: #8B0000;
  --coupon-bg: #FAFAF8;
}

html { scroll-behavior: smooth; }

body {
  font-family: 'IBM Plex Mono', 'Courier New', monospace;
  background: var(--beige);
  color: var(--black);
  font-size: 14px;
  line-height: 1.7;
  min-height: 100vh;
  transition: background-color 0.08s linear;
}

body.flicker { background-color: var(--beige-flicker); }

/* === FIXED HEADER BAR === */
.header-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 36px;
  background: var(--black);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  z-index: 9999;
  font-size: 10px;
}

.header-bar .logo {
  font-size: 13px;
  color: var(--beige);
  text-transform: uppercase;
  letter-spacing: 3px;
  font-weight: 700;
  white-space: nowrap;
}

.header-bar .session-timer {
  color: var(--yellow);
  font-size: 11px;
  letter-spacing: 1px;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
}

.header-bar .status {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--teal);
  white-space: nowrap;
}

.header-bar .status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #4a9;
  animation: blink-dot 1s step-end infinite;
}

@keyframes blink-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}

/* === MAIN CONTENT === */
.main-content {
  padding-top: 60px;
  padding-bottom: 40px;
}

/* === INTAKE NOTICE === */
.intake-notice {
  max-width: 680px;
  margin: 48px auto 0;
  padding: 32px;
  border: 1px solid var(--gray);
  position: relative;
}

.intake-notice .legend {
  position: absolute;
  top: -9px;
  left: 20px;
  background: var(--beige);
  padding: 0 10px;
  font-size: 10px;
  text-transform: uppercase;
  color: var(--red);
  letter-spacing: 1px;
  font-weight: 700;
}

.intake-notice p { margin-bottom: 16px; }
.intake-notice p:last-of-type { margin-bottom: 12px; }

.intake-notice .signature {
  text-align: right;
  font-style: italic;
  font-size: 12px;
  color: var(--gray);
}

/* === ROTARY PHONE SECTION === */
.rotary-section {
  text-align: center;
  margin: 80px auto 0;
  max-width: 680px;
  padding: 0 20px;
}

.rotary-section .auth-label {
  font-size: 11px;
  text-transform: uppercase;
  color: var(--gray);
  letter-spacing: 2px;
  margin-bottom: 12px;
}

.rotary-section .code-display {
  font-size: 18px;
  font-weight: 700;
  color: var(--black);
  letter-spacing: 4px;
  margin-bottom: 32px;
}

.dial-container {
  position: relative;
  width: 280px;
  height: 280px;
  margin: 0 auto 24px;
}

.dial-outer {
  width: 280px;
  height: 280px;
  border-radius: 50%;
  border: 2px solid var(--gray);
  background: var(--black);
  position: relative;
  transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.dial-hole {
  position: absolute;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--beige);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.15s;
  user-select: none;
}

.dial-hole:hover { background: #B8B0A8; }
.dial-hole:active { background: #A8A098; }

.dial-hole .digit-label {
  font-size: 15px;
  font-weight: 700;
  color: var(--black);
  pointer-events: none;
}

/* PIN display */
.pin-display {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 16px;
}

.pin-slot {
  width: 44px;
  height: 50px;
  border: 2px solid var(--gray);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 700;
  color: white;
  transition: all 0.2s;
}

.pin-slot.filled {
  background: var(--teal);
  border-color: var(--teal);
}

.pin-slot.error {
  background: var(--red);
  border-color: var(--red);
}

.dial-error {
  font-size: 11px;
  color: var(--red);
  font-style: italic;
  min-height: 20px;
  margin-top: 8px;
  transition: opacity 0.3s;
}

.idle-warning {
  font-size: 11px;
  color: var(--red);
  font-style: italic;
  margin-top: 16px;
  transition: opacity 0.5s;
}

/* === BOOKING FORM === */
.booking-section {
  max-width: 620px;
  margin: 60px auto 0;
  padding: 0 20px;
  transition: opacity 0.6s ease, transform 0.6s ease;
}

.booking-section[data-hidden="true"] {
  opacity: 0;
  pointer-events: none;
  transform: translateY(12px);
  position: absolute;
  left: -9999px;
}

.form-table {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid var(--gray);
}

.form-table caption {
  background: var(--black);
  color: var(--beige);
  padding: 12px 16px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 2px;
  text-align: left;
  caption-side: top;
}

.form-table td {
  padding: 12px 16px;
  border: 1px solid var(--gray);
  vertical-align: middle;
  font-size: 13px;
}

.form-table tr:nth-child(even) td { background: var(--beige); }
.form-table tr:nth-child(odd) td { background: #C3BBB1; }

.form-table .label-cell {
  width: 38%;
  font-weight: 700;
  text-transform: uppercase;
  font-size: 11px;
  letter-spacing: 1px;
  color: var(--black);
}

.form-table input[type="text"],
.form-table select {
  width: 100%;
  padding: 8px 10px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 13px;
  border: 1px solid var(--gray);
  background: var(--coupon-bg);
  color: var(--black);
  outline: none;
}

.form-table input[type="text"]:focus,
.form-table select:focus {
  border-color: var(--teal);
  box-shadow: 0 0 0 1px var(--teal);
}

.form-table select { cursor: pointer; }

.radio-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.radio-option {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  cursor: pointer;
  padding: 6px 10px;
  border: 1px solid transparent;
  transition: border-color 0.15s;
}

.radio-option:hover { border-color: var(--gray); }

.radio-option input[type="radio"] {
  margin-top: 3px;
  accent-color: var(--teal);
  cursor: pointer;
}

.radio-option .radio-label {
  font-size: 12px;
  line-height: 1.5;
}

.waiver-row td { background: #D4C95720 !important; }

.waiver-label {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  cursor: pointer;
  font-size: 12px;
  line-height: 1.5;
}

.waiver-label input[type="checkbox"] {
  margin-top: 3px;
  accent-color: var(--red);
  cursor: pointer;
  flex-shrink: 0;
}

.submit-btn {
  display: block;
  width: 100%;
  margin-top: 0;
  padding: 16px;
  background: var(--teal);
  color: white;
  border: none;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  cursor: crosshair;
  transition: background 0.15s;
}

.submit-btn:hover { background: var(--teal-dark); }

.submit-btn:disabled {
  background: var(--gray);
  cursor: not-allowed;
  opacity: 0.5;
}

/* === DOT-MATRIX COUPON === */
.coupon-section {
  max-width: 540px;
  margin: 60px auto 0;
  padding: 0 20px;
  transition: opacity 0.6s ease;
}

.coupon-section[data-hidden="true"] {
  opacity: 0;
  pointer-events: none;
  position: absolute;
  left: -9999px;
}

.coupon {
  border: 2px dashed var(--gray);
  padding: 36px 40px;
  background: var(--coupon-bg);
  font-family: 'Fira Code', 'IBM Plex Mono', monospace;
  font-size: 13px;
  line-height: 1.6;
  filter: contrast(1.1) brightness(0.97);
  white-space: pre-wrap;
  word-break: break-word;
  position: relative;
}

.coupon::before {
  content: '';
  position: absolute;
  inset: 4px;
  border: 1px dashed #ccc;
  pointer-events: none;
}

.coupon-actions {
  text-align: center;
  margin-top: 20px;
}

.coupon-actions a {
  color: var(--teal);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 2px;
  text-decoration: none;
  cursor: pointer;
  border-bottom: 1px dotted var(--teal);
}

.coupon-actions a:hover { color: var(--teal-dark); }

.session-stamp {
  text-align: center;
  margin-top: 16px;
  font-size: 11px;
  color: var(--red);
  letter-spacing: 1px;
}

/* === TESTIMONIALS TICKER === */
.ticker-strip {
  margin-top: 80px;
  background: var(--black);
  overflow: hidden;
  padding: 14px 0;
  position: relative;
}

.ticker-track {
  display: flex;
  white-space: nowrap;
  animation: ticker-scroll 80s linear infinite;
  width: max-content;
}

.ticker-track span {
  color: var(--beige);
  font-size: 12px;
  padding: 0 4px;
  flex-shrink: 0;
}

@keyframes ticker-scroll {
  from { transform: translateX(0); }
  to { transform: translateX(-50%); }
}

/* === FAQ SECTION === */
.faq-section {
  max-width: 680px;
  margin: 60px auto 0;
  padding: 0 20px 60px;
}

.faq-section h2 {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--gray);
  margin-bottom: 32px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--gray);
}

.faq-item {
  margin-bottom: 0;
  border-bottom: 1px solid #B8B0A8;
}

.faq-item summary {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 0;
  cursor: pointer;
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--black);
  letter-spacing: 0.5px;
  list-style: none;
  user-select: none;
}

.faq-item summary::-webkit-details-marker { display: none; }

.faq-item summary .marker {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  font-size: 16px;
  color: var(--teal);
  transition: transform 0.25s ease;
  flex-shrink: 0;
}

.faq-item[open] summary .marker { transform: rotate(45deg); }

.faq-item .answer {
  padding: 0 0 20px 32px;
  border-left: 2px solid var(--teal);
  margin-left: 9px;
  font-size: 13px;
  color: var(--gray);
  line-height: 1.6;
}

/* === FOOTER === */
.site-footer {
  background: var(--black);
  padding: 28px 20px;
  text-align: center;
}

.site-footer p {
  margin-bottom: 4px;
}

.site-footer .line1 { font-size: 11px; color: var(--beige); }
.site-footer .line2 { font-size: 10px; color: var(--gray); }
.site-footer .line3 { font-size: 10px; color: var(--gray); }

/* === RESPONSIVE === */
@media (max-width: 640px) {
  .header-bar { padding: 0 12px; font-size: 9px; }
  .header-bar .logo { font-size: 11px; letter-spacing: 2px; }
  .header-bar .session-timer { font-size: 10px; }
  .header-bar .status { font-size: 9px; }
  .intake-notice { margin: 36px 16px 0; padding: 24px; }
  .rotary-section { margin-top: 48px; }
  .dial-container { width: 240px; height: 240px; }
  .dial-outer { width: 240px; height: 240px; }
  .booking-section { padding: 0 16px; }
  .form-table .label-cell { width: 30%; font-size: 10px; }
  .coupon { padding: 24px 20px; font-size: 11px; }
  .faq-section { padding: 0 16px 60px; }
}

/* Print styles for coupon */
@media print {
  body { background: white !important; }
  .header-bar, .intake-notice, .rotary-section, .booking-section, .ticker-strip, .faq-section, .site-footer, .idle-warning { display: none !important; }
  .coupon-section { margin: 0 !important; padding: 20px !important; opacity: 1 !important; max-height: none !important; }
  .coupon-section.hidden { display: block !important; opacity: 1 !important; max-height: none !important; overflow: visible !important; }
  .coupon { border: 2px dashed #000; filter: none; }
  .coupon-actions { display: none; }
}
</style>
</head>
<body x-data="hrvinsula()" x-effect="runFlicker()">

<!-- FIXED HEADER -->
<div class="header-bar">
  <div class="logo">HRVinsula.de</div>
  <div class="session-timer" x-text="'SESSION: ' + formatTime(elapsed)"></div>
  <div class="status">
    <div class="status-dot"></div>
    <span>OPERATIONAL SINCE 1996</span>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">

  <!-- INTAKE NOTICE -->
  <div class="intake-notice">
    <div class="legend">Intake Notice — Read Before Proceeding</div>
    <p>You have arrived at HRVinsula, a recovery service operating from a decommissioned weather shack in Düsseldorf since 1996. We do not have an app. We do not have a podcast. We have a rotary phone, a beige cubicle, and 45 minutes of your undivided respiratory attention.</p>
    <p>You will hyperventilate. You will be shackled. You will be guided by a certified Breathwork Enforcer. At the conclusion of your session, you will receive a dot-matrix coupon redeemable for a 1998 Taco Bell Crunchwrap Supreme at its original price of $1.29.</p>
    <p>This is not wellness. This is recovery. There is a difference.</p>
    <div class="signature">— Klaus Vanderwalt, Founder &amp; Chief Enforcer</div>
  </div>

  <!-- ROTARY PHONE SECTION -->
  <div class="rotary-section">
    <div class="auth-label">Authentication Required — Rotate to Confirm Humanity</div>
    <div class="code-display">DIAL RESET CODE: 1 – 9 – 9 – 8</div>

    <div class="dial-container">
      <div class="dial-outer" :style="dialRotation">
        <template x-for="(hole, i) in dialHoles" :key="i">
          <div class="dial-hole"
               :style="hole.style"
               @click="dialDigit(hole.digit)">
            <span class="digit-label" x-text="hole.digit"></span>
          </div>
        </template>
      </div>
    </div>

    <!-- PIN Display -->
    <div class="pin-display">
      <template x-for="(slot, i) in 4" :key="i">
        <div class="pin-slot"
             :class="{
               'filled': dialedDigits[i] !== null && !dialError,
               'error': dialError
             }"
             x-text="dialedDigits[i] !== null ? dialedDigits[i] : ''">
        </div>
      </template>
    </div>

    <div class="dial-error" x-show="dialError" x-transition.opacity>
      INCORRECT CODE. The phone remembers.
    </div>

    <div class="idle-warning"
         x-show="showIdleWarning && !unlocked"
         x-transition.opacity>
      You have been sitting here for over five minutes without dialing. This is exactly the kind of avoidance behavior we treat. Dial the code.
    </div>
  </div>

  <!-- BOOKING FORM (hidden until unlocked) -->
  <div class="booking-section" :data-hidden="(!unlocked || couponIssued).toString()">
    <table class="form-table">
      <caption>Reset Protocol Scheduling — Form RP-2024</caption>
      <tr>
        <td class="label-cell">Participant Designation</td>
        <td><input type="text" x-model="formName" placeholder="SURNAME, FIRST INITIAL"></td>
      </tr>
      <tr>
        <td class="label-cell">Preferred Reset Day</td>
        <td>
          <select x-model="formDay">
            <option value="">— SELECT DAY —</option>
            <option value="MONDAY (Optimal Dread)">MONDAY (Optimal Dread)</option>
            <option value="WEDNESDAY (Peak Futility)">WEDNESDAY (Peak Futility)</option>
            <option value="FRIDAY (Pre-Weekend Panic)">FRIDAY (Pre-Weekend Panic)</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="label-cell">Session Intensity</td>
        <td>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="intensity" value="STANDARD (45 min, light shackling)" x-model="formIntensity">
              <span class="radio-label">STANDARD — 45 min, light shackling</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="intensity" value="ELEVATED (45 min, full restraint)" x-model="formIntensity">
              <span class="radio-label">ELEVATED — 45 min, full restraint</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="intensity" value="KLAUS PROTOCOL (60 min, phone cord wrapped twice)" x-model="formIntensity">
              <span class="radio-label">KLAUS PROTOCOL — 60 min, phone cord wrapped twice</span>
            </label>
          </div>
        </td>
      </tr>
      <tr>
        <td class="label-cell">Taco Bell Redemption</td>
        <td>
          <select x-model="formItem">
            <option value="">— SELECT ITEM —</option>
            <option value="Bean Burrito">Bean Burrito</option>
            <option value="Nachos BellGrande (no extras)">Nachos BellGrande (no extras)</option>
            <option value="Cinnamon Twists">Cinnamon Twists</option>
            <option value="Small Pepsi">Small Pepsi</option>
          </select>
        </td>
      </tr>
      <tr class="waiver-row">
        <td colspan="2">
          <label class="waiver-label">
            <input type="checkbox" x-model="formWaiver">
            <span>I acknowledge that any modern device interference during my session incurs a mandatory €25 fee and immediate session termination. I accept that my smartphone is the enemy of my lungs.</span>
          </label>
        </td>
      </tr>
    </table>
    <button class="submit-btn"
            :disabled="!formValid"
            @click="submitForm()">
      Submit for Processing
    </button>
  </div>

  <!-- DOT-MATRIX COUPON (hidden until submitted) -->
  <div class="coupon-section" :data-hidden="(!couponIssued).toString()">
    <div class="coupon" x-html="couponText"></div>
    <div class="coupon-actions">
      <a @click.prevent="window.print()">Print This Coupon</a>
    </div>
    <div class="session-stamp" x-show="couponIssued" x-text="'SESSION ELAPSED: ' + couponElapsed"></div>
  </div>

  <!-- TESTIMONIALS TICKER -->
  <div class="ticker-strip">
    <div class="ticker-track">
      <span>&#9670; "Finally, I feel balanced... just like that time in '98 when Supreme actually meant something." &#9670; "The phone cord left marks on my wrist for three days. I have never slept better." &#9670; "Klaus told me to stop breathing. I did. Then he told me to start again. I cried." &#9670; "I tried to check my email during the session. They charged me €25 and made me dial the weather line for Tacoma. It was raining. It's always raining in Tacoma." &#9670; "My therapist says this isn't therapy. Klaus says my therapist isn't breathing correctly." &#9670; "The ceiling stain looked like my father. I think that was the point." &#9670; "I came for the coupon. I stayed because the cubicle was the first quiet room I'd been in since 2019." &#9670; "I don't know what happened in there but I apologized to everyone in my contacts list afterward." &#9670; "The Crunchwrap coupon expired before I was born. I framed it." &#9670;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&#9670; "Finally, I feel balanced... just like that time in '98 when Supreme actually meant something." &#9670; "The phone cord left marks on my wrist for three days. I have never slept better." &#9670; "Klaus told me to stop breathing. I did. Then he told me to start again. I cried." &#9670; "I tried to check my email during the session. They charged me €25 and made me dial the weather line for Tacoma. It was raining. It's always raining in Tacoma." &#9670; "My therapist says this isn't therapy. Klaus says my therapist isn't breathing correctly." &#9670; "The ceiling stain looked like my father. I think that was the point." &#9670; "I came for the coupon. I stayed because the cubicle was the first quiet room I'd been in since 2019." &#9670; "I don't know what happened in there but I apologized to everyone in my contacts list afterward." &#9670; "The Crunchwrap coupon expired before I was born. I framed it." &#9670;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
    </div>
  </div>

  <!-- FAQ SECTION -->
  <div class="faq-section">
    <h2>Frequently Asked Questions — Abridged</h2>

    <details class="faq-item">
      <summary><span class="marker">+</span> What happens if I use my smartphone during a session?</summary>
      <div class="answer">Your session is immediately voided. You will be rerouted to our partner line for real-time 1998 Tacoma weather updates. The current temperature in Tacoma is always disappointing. The €25 device interference fee is non-negotiable and non-refundable. Klaus does not accept Venmo.</div>
    </details>

    <details class="faq-item">
      <summary><span class="marker">+</span> Is the Crunchwrap Supreme coupon actually redeemable?</summary>
      <div class="answer">The coupon is redeemable at any participating Taco Bell location currently operating in the year 1998. If you can locate such a location, you have already achieved a level of temporal mastery that renders the coupon unnecessary. The coupon is proof of survival, not a meal plan.</div>
    </details>

    <details class="faq-item">
      <summary><span class="marker">+</span> Who is the Breathwork Enforcer?</summary>
      <div class="answer">Your Breathwork Enforcer is a certified professional trained in the HRVinsula Method, which combines controlled hyperventilation, rotary-phone haptic feedback, and prolonged exposure to water-stained ceiling patterns. All Enforcers have completed a minimum of 2,000 hours of cubicle-based respiratory supervision. Klaus personally interviews each candidate by phone. The interview lasts 45 minutes. They are not told this in advance.</div>
    </details>

    <details class="faq-item">
      <summary><span class="marker">+</span> What is the Klaus Protocol?</summary>
      <div class="answer">The Klaus Protocol is our premium session tier. It involves 60 minutes of guided hyperventilation with the phone cord wrapped twice around the participant's dominant wrist. The session concludes with Klaus himself reading your coupon serial number aloud over the intercom in a tone that has been described as "aggressively neutral." Availability is limited to Wednesdays.</div>
    </details>

    <details class="faq-item">
      <summary><span class="marker">+</span> Can I book online?</summary>
      <div class="answer">You are booking online. This is as online as it gets. If you want something more digital, we cannot help you. We suggest downloading BreatheEasy 2023 and subscribing to Instant Zen Alerts for $9.99/month. When that fails — and it will — we will still be here. The phone will still be here. The cubicle does not expire.</div>
    </details>
  </div>
</div>

<!-- FOOTER -->
<div class="site-footer">
  <p class="line1">HRVinsula.de — Düsseldorf, Germany — Operating from a decommissioned weather shack since 1996</p>
  <p class="line2">No cookies. No tracking. No app. No mercy.</p>
  <p class="line3">© 1996–2024 Klaus Vanderwalt. All breathing rights reserved.</p>
</div>

<script src="/assets/js/alpine.min.js" defer></script>
<script>
document.addEventListener('alpine:init', function() {
  Alpine.data('hrvinsula', function() {
    // Rotary phone dial layout: digits 1-9, 0 arranged in classic clockwise arc
    // Real rotary: 1 at ~2 o'clock, going clockwise, 0 at ~10 o'clock
    // In CSS coordinates: 0deg = right, 90deg = down, angles go clockwise
    var radius = 104;
    var dialSize = 280;
    var holeSize = 36;
    var digits = [0, 9, 8, 7, 6, 5, 4, 3, 2, 1]; // reversed so 1 is at top-right
    // Arc from about 200 degrees (lower-left, where 0 sits) to -40 degrees (upper-right, where 1 sits)
    // Going counter-clockwise in our array: 0 at 200deg, 9 at 175deg, ... 1 at -25deg
    var startAngle = 200; // 0 starts here (lower-left)
    var sweepPerDigit = -25; // each next digit moves counter-clockwise (towards upper-right)

    var holes = digits.map(function(d, i) {
      var angleDeg = startAngle + (i * sweepPerDigit);
      var angleRad = (angleDeg * Math.PI) / 180;
      var cx = (dialSize / 2) + radius * Math.cos(angleRad) - (holeSize / 2);
      var cy = (dialSize / 2) + radius * Math.sin(angleRad) - (holeSize / 2);
      return {
        digit: d,
        style: 'left:' + cx + 'px;top:' + cy + 'px'
      };
    });

    // Audio: tiny rotary click via oscillator
    function playClick() {
      try {
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 800;
        osc.type = 'square';
        gain.gain.value = 0.08;
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.06);
        osc.stop(ctx.currentTime + 0.06);
      } catch(e) {}
    }

    function playError() {
      try {
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 200;
        osc.type = 'sawtooth';
        gain.gain.value = 0.06;
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
        osc.stop(ctx.currentTime + 0.2);
      } catch(e) {}
    }

    function playSuccess() {
      try {
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        [440, 554, 659].forEach(function(freq, i) {
          var osc = ctx.createOscillator();
          var gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          gain.gain.value = 0.06;
          osc.start(ctx.currentTime + i * 0.12);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.12 + 0.15);
          osc.stop(ctx.currentTime + i * 0.12 + 0.15);
        });
      } catch(e) {}
    }

    var targetCode = [1, 9, 9, 8];

    return {
      // Timer
      elapsed: 0,
      _timerInterval: null,

      // Flicker
      flickerBase: 3000,
      _flickerTimeout: null,

      // Dial
      dialHoles: holes,
      dialedDigits: [null, null, null, null],
      currentIndex: 0,
      dialError: false,
      dialRotationDeg: 0,
      unlocked: false,
      showIdleWarning: false,
      hasInteracted: false,

      // Form
      formName: '',
      formDay: '',
      formIntensity: '',
      formItem: '',
      formWaiver: false,

      // Coupon
      couponIssued: false,
      couponText: '',
      couponElapsed: '',

      get dialRotation() {
        return 'transform: rotate(' + this.dialRotationDeg + 'deg)';
      },

      get formValid() {
        return this.formName.trim() !== '' &&
               this.formDay !== '' &&
               this.formIntensity !== '' &&
               this.formItem !== '' &&
               this.formWaiver;
      },

      init() {
        var self = this;

        // Session timer
        this._timerInterval = setInterval(function() {
          self.elapsed++;
          // Idle warning after 5 min without interacting
          if (self.elapsed >= 300 && !self.hasInteracted && !self.unlocked) {
            self.showIdleWarning = true;
          }
          // Increase flicker after 10 min
          if (self.elapsed >= 600) {
            self.flickerBase = 1500;
          }
        }, 1000);
      },

      runFlicker() {
        var self = this;
        if (this._flickerTimeout) clearTimeout(this._flickerTimeout);
        function flick() {
          var delay = self.flickerBase + Math.random() * 4000;
          self._flickerTimeout = setTimeout(function() {
            document.body.classList.add('flicker');
            setTimeout(function() {
              document.body.classList.remove('flicker');
            }, 80);
            flick();
          }, delay);
        }
        flick();
      },

      formatTime(s) {
        var h = Math.floor(s / 3600);
        var m = Math.floor((s % 3600) / 60);
        var sec = s % 60;
        return String(h).padStart(2, '0') + ':' +
               String(m).padStart(2, '0') + ':' +
               String(sec).padStart(2, '0');
      },

      dialDigit(d) {
        if (this.unlocked || this.dialError) return;

        this.hasInteracted = true;
        this.showIdleWarning = false;

        playClick();

        // Rotate dial proportionally — higher digit = more rotation
        var rotAmount = (d === 0 ? 10 : d) * 28;
        this.dialRotationDeg = rotAmount;

        var self = this;
        setTimeout(function() {
          self.dialRotationDeg = 0;
        }, 800);

        // Check the digit
        if (d === targetCode[this.currentIndex]) {
          this.dialedDigits[this.currentIndex] = d;
          this.currentIndex++;

          if (this.currentIndex === 4) {
            // Success!
            playSuccess();
            setTimeout(function() {
              self.unlocked = true;
            }, 500);
          }
        } else {
          // Wrong digit
          this.dialedDigits[this.currentIndex] = d;
          this.dialError = true;
          playError();

          setTimeout(function() {
            self.dialError = false;
            self.dialedDigits = [null, null, null, null];
            self.currentIndex = 0;
          }, 1200);
        }
      },

      submitForm() {
        if (!this.formValid) return;

        this.couponElapsed = this.formatTime(this.elapsed);

        // Generate serial
        var serial = '';
        var hex = '0123456789ABCDEF';
        for (var i = 0; i < 12; i++) {
          serial += hex[Math.floor(Math.random() * 16)];
        }

        // Format date
        var now = new Date();
        var dd = String(now.getDate()).padStart(2, '0');
        var mm = String(now.getMonth() + 1).padStart(2, '0');
        var yyyy = now.getFullYear();
        var dateStr = dd + '.' + mm + '.' + yyyy;

        var name = this.formName.trim().toUpperCase() || 'UNSPECIFIED';
        var item = this.formItem;
        var day = this.formDay;

        var lines = [
          '═══════════════════════════════════════════',
          '           H R V i n s u l a . d e',
          '         OFFICIAL REDEMPTION COUPON',
          '═══════════════════════════════════════════',
          '',
          '  ITEM:        ' + item,
          '  PRICE:       $1.29 (ORIGINAL 1998 MSRP)',
          '',
          '  PARTICIPANT: ' + name,
          '  SESSION:     ' + day,
          '  ISSUED:      ' + dateStr,
          '',
          '  VALID AT:    Any participating Taco Bell',
          '               location operating in the',
          '               year 1998.',
          '',
          '  SERIAL:      ' + serial,
          '',
          '  "You survived. The phone forgives you."',
          '',
          '═══════════════════════════════════════════',
          '  This coupon was printed on a dot-matrix',
          '  printer that has not been serviced since',
          '  February 2003. Any smudging is authentic.',
          '═══════════════════════════════════════════'
        ];

        this.couponText = lines.join('\n');
        this.couponIssued = true;
      },

      destroy() {
        if (this._timerInterval) clearInterval(this._timerInterval);
        if (this._flickerTimeout) clearTimeout(this._flickerTimeout);
      }
    };
  });
});
</script>
</body>
</html>
